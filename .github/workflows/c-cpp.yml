name: Build and Release

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*'
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  CUDA_VERSION: '12.9.0'

jobs:
  provision-vm:
    name: Start VM
    runs-on: ubuntu-latest
    outputs:
      vm_name: ${{ steps.create-vm.outputs.vm_name }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v2.3.0
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Create VM
      id: create-vm
      env:
        AZURE_RESOURCE_GROUP: "gh-runners-rg"
        AZURE_LOCATION: "eastus"
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
        ADMIN_PASSWORD: ${{ secrets.VM_ADMIN_PASSWORD }}
      run: |
        chmod +x .github/scripts/provision-gpu-runner.sh
        .github/scripts/provision-gpu-runner.sh


  build:
    runs-on: [self-hosted, gpu, cuda, windows]
    
    strategy:
      matrix:
        include:
          - name: "Windows-x64-Release"
            architecture: x64
            build_config: Release

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure CMake
      run: |
        cmake --preset=windows-release
      shell: powershell

    - name: Build
      run: cmake --build build/windows-release --config ${{ matrix.build_config }}
      shell: powershell

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cuda-build-windows-x64
        path: |
          build/windows-release/**/*.exe
          build/windows-release/**/*.dll
          build/windows-release/**/*.lib
          build/windows-release/Testing/
        retention-days: 1